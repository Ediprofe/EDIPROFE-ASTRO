---
import BaseLayout from './BaseLayout.astro';
import Footer from '../components/Layout/Footer.astro';
import CollapsibleSidebar from '../components/Navigation/CollapsibleSidebar.astro';
import Breadcrumb from '../components/Navigation/Breadcrumb.astro';
import TableOfContents from '../components/Content/TableOfContents.astro';
import MobileMenu from '../components/Navigation/MobileMenu.astro';
import { getMetaName } from '../utils/load-meta';
import { formatName, formatBlockName } from '../utils/navigation-generator.js';
import { materiaConfig } from '../config/materias';
import { isMateriaSlug } from '../types/content';

interface Props {
  frontmatter: {
    title?: string;
    description?: string;
  };
  headings: Array<{ depth: number; slug: string; text: string }>;
  url: string;
  prevLesson?: { slug: string; title: string } | null;
  nextLesson?: { slug: string; title: string } | null;
}

const { frontmatter, headings, url, prevLesson, nextLesson } = Astro.props;
const title = frontmatter.title || headings.find(h => h.depth === 1)?.text || 'Sin título';

// Extraer navegación de la URL
const pathParts = url.split('/').filter(Boolean);
const materia = pathParts[0] || '';
const unidad = pathParts[1] || '';
const bloque = pathParts[2] || '';

// Configuración de colores por materia (usar centralizada)
const config = isMateriaSlug(materia) 
  ? materiaConfig[materia] 
  : materiaConfig.fisica;

// Obtener nombres con tildes desde metadatos
const unidadKey = `${materia}/${unidad}`;
const bloqueKey = `${materia}/${unidad}/${bloque}`;
const unidadName = getMetaName(unidadKey, formatName(unidad));
const bloqueName = getMetaName(bloqueKey, formatBlockName(bloque));
---

<BaseLayout title={title} description={frontmatter.description}>
  <MobileMenu currentPath={url} />
  
  <div class="lesson-container">
    <CollapsibleSidebar currentPath={url} />
    
    <main class="lesson-content">
      <Breadcrumb materia={materia} unidad={unidad} bloque={bloque} />
      
      <article class={`content-article content-article-${materia}`}>
        <!-- Header de lección -->
        <header class="lesson-header">
          <h1 class="lesson-title">{title}</h1>
          
          {frontmatter.description && (
            <p class="lesson-description">{frontmatter.description}</p>
          )}
        </header>
        
        {headings.length > 2 && (
          <TableOfContents headings={headings} />
        )}
        
        <div class="content-body">
          <slot />
        </div>
      </article>
      
      <!-- Navegación Premium -->
      <nav class="lesson-navigation">
        {prevLesson ? (
          <a href={`/${prevLesson.slug}`} class="nav-card nav-prev">
            <div class="nav-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
              </svg>
            </div>
            <div class="nav-content">
              <span class="nav-label">Lección anterior</span>
              <span class="nav-title">{prevLesson.title}</span>
            </div>
          </a>
        ) : (
          <span class="nav-placeholder"></span>
        )}
        
        {nextLesson ? (
          <a href={`/${nextLesson.slug}`} class="nav-card nav-next">
            <div class="nav-content">
              <span class="nav-label">Siguiente lección</span>
              <span class="nav-title">{nextLesson.title}</span>
            </div>
            <div class="nav-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M5 12h14M12 5l7 7-7 7"/>
              </svg>
            </div>
          </a>
        ) : (
          <span class="nav-placeholder"></span>
        )}
      </nav>
    </main>
  </div>
  
  <Footer variant="minimal" />
</BaseLayout>

<style>
  @import '../styles/layouts/lesson.css';
</style>
