---
import BaseLayout from './BaseLayout.astro';
import Footer from '../components/Layout/Footer.astro';
import CollapsibleSidebar from '../components/Navigation/CollapsibleSidebar.astro';
import Breadcrumb from '../components/Navigation/Breadcrumb.astro';
import TableOfContents from '../components/Content/TableOfContents.astro';
import MobileMenu from '../components/Navigation/MobileMenu.astro';
import { allMeta } from '../utils/load-meta.js';
import { formatName, formatBlockName } from '../utils/navigation-generator.js';

interface Props {
  frontmatter: {
    title?: string;
    description?: string;
  };
  headings: Array<{ depth: number; slug: string; text: string }>;
  url: string;
  prevLesson?: { slug: string; title: string } | null;
  nextLesson?: { slug: string; title: string } | null;
}

const { frontmatter, headings, url, prevLesson, nextLesson } = Astro.props;
const title = frontmatter.title || headings.find(h => h.depth === 1)?.text || 'Sin t铆tulo';

// Extraer navegaci贸n de la URL
const pathParts = url.split('/').filter(Boolean);
const materia = pathParts[0] || '';
const unidad = pathParts[1] || '';
const bloque = pathParts[2] || '';

// Configuraci贸n de colores por materia
const materiaConfig: Record<string, { icon: string; color: string; gradient: string }> = {
  matematicas: { icon: 'М', color: '#ef4444', gradient: 'linear-gradient(135deg, #ef4444, #dc2626)' },
  fisica: { icon: '', color: '#3b82f6', gradient: 'linear-gradient(135deg, #3b82f6, #2563eb)' },
  quimica: { icon: '锔', color: '#a855f7', gradient: 'linear-gradient(135deg, #a855f7, #9333ea)' },
  ciencias: { icon: '', color: '#22c55e', gradient: 'linear-gradient(135deg, #22c55e, #16a34a)' },
};
const config = materiaConfig[materia] || materiaConfig.fisica;
const materiaName = materia.charAt(0).toUpperCase() + materia.slice(1);

// Obtener nombres con tildes desde metadatos
const unidadKey = `${materia}/${unidad}`;
const bloqueKey = `${materia}/${unidad}/${bloque}`;
const unidadName = (allMeta as any)[unidadKey]?.name || formatName(unidad);
const bloqueName = (allMeta as any)[bloqueKey]?.name || formatBlockName(bloque);
---

<BaseLayout title={title} description={frontmatter.description}>
  <MobileMenu currentPath={url} />
  
  <div class="lesson-container">
    <CollapsibleSidebar currentPath={url} />
    
    <main class="lesson-content">
      <Breadcrumb materia={materia} unidad={unidad} bloque={bloque} />
      
      <article class={`content-article content-article-${materia}`}>
        <!-- Header de lecci贸n -->
        <header class="lesson-header">
          <h1 class="lesson-title">{title}</h1>
          
          {frontmatter.description && (
            <p class="lesson-description">{frontmatter.description}</p>
          )}
        </header>
        
        {headings.length > 2 && (
          <TableOfContents headings={headings} />
        )}
        
        <div class="content-body">
          <slot />
        </div>
      </article>
      
      <!-- Navegaci贸n Premium -->
      <nav class="lesson-navigation">
        {prevLesson ? (
          <a href={`/${prevLesson.slug}`} class="nav-card nav-prev">
            <div class="nav-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
              </svg>
            </div>
            <div class="nav-content">
              <span class="nav-label">Lecci贸n anterior</span>
              <span class="nav-title">{prevLesson.title}</span>
            </div>
          </a>
        ) : (
          <span class="nav-placeholder"></span>
        )}
        
        {nextLesson ? (
          <a href={`/${nextLesson.slug}`} class="nav-card nav-next">
            <div class="nav-content">
              <span class="nav-label">Siguiente lecci贸n</span>
              <span class="nav-title">{nextLesson.title}</span>
            </div>
            <div class="nav-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M5 12h14M12 5l7 7-7 7"/>
              </svg>
            </div>
          </a>
        ) : (
          <span class="nav-placeholder"></span>
        )}
      </nav>
    </main>
  </div>
  
  <Footer variant="minimal" />
</BaseLayout>

<style>
  @import '../styles/layouts/lesson.css';
</style>
